{
  "hash": "324b4c376df6720547be91f6ea744bab",
  "result": {
    "markdown": "---\ntitle: \"Čístím Search Consoli od zbytečných webů\"\ndescription: |\n  Jako každý SEO konzultantant mám v Google Search Consoli plno webů, ke kterým už nemám přístup, nebo které už dlouho nefungují. Napsal jsem si skript v R, který je odstraní. \nauthor:\n  - name: Marek Prokop\n    affiliation: \"[PROKOP software s.r.o.](https://www.prokopsw.cz/cs)\"\n    affiliation_url: https://www.prokopsw.cz/cs\ndate: 2022-04-10\n---\n\n\n## Příprava\n\nSkriptu stačí tyhle dva balíčky.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(searchConsoleR)\n```\n:::\n\n\nA klasická autorizace do Search Console. Kdybych neměl svůj Google e-mail uložený v systémové proměnné, musel bych ho napsat do parametru `email` přímo.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nscr_auth(email = Sys.getenv(\"MY_GOOGLE_ACCOUNT\"))\n```\n:::\n\n::: {.cell}\n\n:::\n\n\nFunkcí `list_websites` načtu všechny weby, které v Search Consoli mám, a uložím si je do objektu `websites`.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nwebsites <- list_websites()\n```\n:::\n\n\nSeznam vypadá nějak takhle, jen jsem konkrétní weby ze své Search Console anonymizoval, abych mohl výstup publikovat. Když vynechám poslední řádek, budou weby normálně vidět.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nwebsites |> \n  slice_sample(n = 10) |> \n  mutate(siteUrl = anonymize_site(siteUrl))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n                    siteUrl    permissionLevel\n1    http://anonymized.com/       siteFullUser\n2    https://anonymized.cz/       siteFullUser\n3   sc-domain:anonymized.cz       siteFullUser\n4   sc-domain:anonymized.cz siteRestrictedUser\n5   https://anonymized.cz/d       siteFullUser\n6    http://anonymized.cz/p       siteFullUser\n7   https://anonymized.cz/e       siteFullUser\n8   https://anonymized.cz/c       siteFullUser\n9   sc-domain:anonymized.sk       siteFullUser\n10 sc-domain:anonymized.com          siteOwner\n```\n:::\n:::\n\n\n## Neautorizované weby\n\nDůležitý je sloupec `permissionLevel`. Mám v něm tyhle hodnoty:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nwebsites |> \n  count(permissionLevel)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n     permissionLevel  n\n1       siteFullUser 67\n2          siteOwner 32\n3 siteRestrictedUser 17\n4 siteUnverifiedUser  3\n```\n:::\n:::\n\n\nZbavit se chci webů, ke kterým nemám povolený přístup. Vypíšu si je a raději je pečlivě zkontroluju (samozřejmě až odstraním anonymizaci na posledním řádku).\n\n\n::: {.cell}\n\n```{.r .cell-code}\nunverified_websites <- websites |> \n  filter(permissionLevel == \"siteUnverifiedUser\")\n\nunverified_websites |> \n  mutate(siteUrl = anonymize_site(siteUrl))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n                  siteUrl    permissionLevel\n1 sc-domain:anonymized.cz siteUnverifiedUser\n2   http://anonymized.sk/ siteUnverifiedUser\n3   http://anonymized.cz/ siteUnverifiedUser\n```\n:::\n:::\n\n\nZe Search Console si je pak odstraním takto. Jen před tím přepíšu na prvním řádku `FALSE` na `TRUE`. Dal jsem to tam proto, abych si nechtěně nesmazal weby před tím, než si je zkontroluju.\n\n```r\nif (FALSE) {\n  unverified_websites |> \n    pull(siteUrl) |> \n    walk(delete_website)\n}\n```\n\nKdyž to pustím, křičí to na mě nějaké warningy ohledně JSON. Asi je někde nějaká chybka, ale podle všeho ničemu nevadí a skript dělá to, co má. Každopádně si pak můžu ověřit, jestli už jsou všechny neverifikované weby pryč:\n\n```r\nlist_websites() |> \n  filter(permissionLevel == \"siteUnverifiedUser\")\n```\n\n## Weby bez dat\n\nKromě neutorizovaných webů se chci zbavit i těch, které už dlouho nemají žádná data.\n\nNejdřív si definuju funkci, která načte souhrnné metriky jednoho webu za poslední dva roky. K výsledku přidám do prvního sloupce i URL webu, abych ho poznal, až jich bude v tabulce víc.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nget_site_metrics <- function(site) {\n  search_analytics(\n    siteURL = site, \n    startDate = Sys.Date() - 365 * 2, \n  ) |> \n    add_column(site = site, .before = 1)\n}\n```\n:::\n\n\nOvěřím, zda funkce funguje.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nget_site_metrics(\"http://www.marekp.cz/\")\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nFetching search analytics for url: http://www.marekp.cz/ dates: 2021-02-18 2023-02-15 dimensions:  dimensionFilterExp:  searchType: web aggregationType: auto\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n                   site clicks impressions        ctr position\n1 http://www.marekp.cz/   1997       52140 0.03830073 11.22434\n```\n:::\n:::\n\n\nFunguje, takže ji mohu pomocí funkce `map_dfr` z balíčku *purrr* aplikovat na celý seznam webů, ke kterým mám autorizovaný přístup. S více weby to nějakou chvíli poběží.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nall_site_metrics <- websites |> \n  filter(permissionLevel != \"siteUnverifiedUser\") |> \n  pull(siteUrl) |> \n  map_dfr(get_site_metrics)\n```\n:::\n\n\nA teď už jen vyfiltruju a zobrazím (opět anonymizovaně) weby, které nemají žádné imprese.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nall_site_metrics |> \n  filter(impressions == 0) |> \n  mutate(site = anonymize_site(site))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n                      site clicks impressions ctr position\n1   http://anonymized.com/      0           0   0        0\n2   http://anonymized.net/      0           0   0        0\n3   https://anonymized.cz/      0           0   0        0\n4    http://anonymized.sk/      0           0   0        0\n5 sc-domain:anonymized.com      0           0   0        0\n6  https://anonymized.com/      0           0   0        0\n7   https://anonymized.cz/      0           0   0        0\n8   http://anonymized.com/      0           0   0        0\n```\n:::\n:::\n\n\nPokud je chci ze Search Console odebrat, udělám to podle návodu pro neautorizované weby výše.\n\nA to je všechno :-)\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}